<div class="modal-header">
  <i class="fa fa-times-circle close" style="font-size: 24px;" aria-label="Close" (click)="modal.dismiss()">
  </i>
</div>
<div class="modal-body">

  <div class="row">
    <div class="col-xs-12">
      <h3>
        Prepare green coffee
      </h3>
    </div>
  </div>
  <app-list-message [message]="message"></app-list-message>
  <app-list-errors [errorList]="errors"></app-list-errors>
  <div class="row filter-form" style="margin-top: 15px;">
    <form [formGroup]="filterForm" (ngSubmit)="onFilter()">
      <div class="col-xs-2">
        <div class="ng-autocomplete">
          <ng-autocomplete
            #supplier
            [data]="organisations"
            [searchKeyword]="keyword"
            (selected)='selectEvent($event)'
            (inputCleared)='deselectEvent()'
            [initialValue]="initialValue.name"
            [isLoading]="isLoading"
            placeholder="'Select supplier'"
            [disabled]="transferType==='processing'"
            [itemTemplate]="itemTemplate"
            [notFoundTemplate]="notFoundTemplate">
          </ng-autocomplete>

          <ng-template #itemTemplate let-item>
            <a [innerHTML]="item.name"></a>
          </ng-template>

          <ng-template #notFoundTemplate let-notFound>
            <div [innerHTML]="notFound"></div>
          </ng-template>
        </div>
      </div>
      <div class="col-xs-2 input-required">
        <select class="form-control" formControlName="type">
          <option value="">type</option>
          <option *ngFor="let type of coffeeTypes" value="{{type._id}}"> {{ type.name }}</option>
        </select>
        <span class="asterisk"></span>
      </div>
      <div class="col-xs-1 input-required">
        <select class="form-control" formControlName="grade">
          <option value="">grade</option>
          <option value="A"> A</option>
          <option value="B"> B</option>
          <option value="C"> C</option>
        </select>
        <span class="asterisk"></span>
      </div>
      <div class="col-xs-2">
        <div class="form-inline">
          <div class="radio">
            <label>
              <input type="radio" formControlName="transferType" value="sold">
              Sold
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" formControlName="transferType" value="processing" checked="">
              Processing
            </label>
          </div>
        </div>
      </div>
      <ng-container formGroupName="deliveryDate">
        <div class="col-xs-1">
          <div class="form-group">
            <input [owlDateTimeTrigger]="dt1" [owlDateTime]="dt1" formControlName="from" class="form-control"
                   placeholder="from .." [min]="seasonStartingDate" [max]="currentDate">
            <owl-date-time [pickerType]="'calendar'" #dt1></owl-date-time>
          </div>
        </div>
        <div class="col-xs-1">
          <div class="form-group">
            <input [owlDateTimeTrigger]="dt2" [owlDateTime]="dt2" formControlName="to"
                   class="form-control label-optional"
                   placeholder="to .." [min]="seasonStartingDate" [max]="currentDate">
            <owl-date-time [pickerType]="'calendar'" #dt2></owl-date-time>
          </div>
        </div>
      </ng-container>
      <div class="col-xs-1">
        <div class="form-group">
          <input type="number" formControlName="amount" min="0" class="form-control label-required"
                 placeholder="quantity ..">
        </div>
      </div>
      <div class="col-xs-2">
        <button class="btn btn-warning btn-margin pull-right" type="button" (click)="onClearFilter()"> Clear</button>

        <button class="btn btn-success btn-margin pull-right" type="submit"><i class="fa fa-filter"></i> Select</button>
      </div>
    </form>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <app-loader *ngIf="loading"></app-loader>
      <table datatable [dtOptions]="dtOptions" [dtTrigger]="dtTriggerItem"
             class="row-border hover table table-striped responsive-table" id="item">
        <thead>
        <tr>
          <td> Supplier</td>
          <td> Coffee type</td>
          <td> Coffee grade</td>
          <td> Qty</td>
          <td></td>
          <td></td>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td> {{ cartItemInfo?.supplier?.name }}</td>
          <td> {{ cartItemInfo.coffeeType.name }} </td>
          <td> {{ cartItemInfo.coffeeGrade }} </td>
          <td> {{ cartItemInfo.totalKgs + ' &#13199;'}} </td>
          <td>
            <table style="background: transparent; width: 650px;" class="pull-right">
              <tr style="font-style: oblique; font-size: 12px; background: transparent; font-weight: bold">
                <td>Qty</td>
                <td>Lots</td>
                <td></td>
              </tr>
              <tr *ngFor="let item of cartItem" style="font-style: oblique; font-size: 12px; background: transparent">
                <td>{{ item.items.amountToDeduct }}</td>
                <td>
                  <ng-container *ngFor="let parchment of item.items.parchments; let i = index">
                    <ng-container *ngIf="parchment?.selected; else not_selected">
                      <a type="button"
                         class="btn btn-sm btn-link select-parchment selected-parchment" data-toggle="tooltip"
                         id="{{ item._id }}-{{ item.items._id }}-{{ parchment._id }}"
                         title="{{'Qty : ' + parchment.remainingQty + '&#13199; ' + ' - ' + parchment?.qtyToDeduct + '&#13199; ' }}"> {{ parchment.lotNumber }}
                      </a>
                    </ng-container>
                    <ng-template #not_selected>
                      <a type="button"
                         class="btn btn-sm btn-link select-parchment " data-toggle="tooltip"
                         id="{{ item._id }}-{{ item.items._id }}-{{ parchment._id }}"
                         title="{{'Qty : ' + parchment.remainingQty + '&#13199; ' + ' - ' + 0 + '&#13199; ' }}"> {{ parchment.lotNumber }}
                      </a>
                    </ng-template>
                  </ng-container>
                </td>
                <td>
                  <a class="btn btn-default btn-margin btn-sm pull-right print-note" id="{{ item._id }}"
                     type="button">
                    <i class="fa fa-print" aria-hidden="true"></i>
                  </a>
                </td>
              </tr>
            </table>
          </td>
          <td>
            <button class="btn btn-default btn-margin btn-sm pull-right" (click)="resetSelection()"
                    type="button">
              <i class="fa fa-remove" aria-hidden="true"></i>
            </button>
            <button class="btn btn-success btn-margin btn-sm pull-right" (click)="addItemToCart()"
                    type="button" [disabled]="addToCartDisabled">
              <i class="fa fa-cart-plus" aria-hidden="true"></i>
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="box">
        <div class="box-header with-border" style="min-height: 35px;">
          <h3 class="box-title"> Cart </h3>
          <div class="box-tools pull-right">
            <a class="btn btn-box-tool" data-target="#box-body" data-toggle="collapse"
               style="padding: 10px; height: auto">
              <span class="badge bg-light-blue-gradient">{{ cart.length }} items</span>
              {{ totalAmount | number }} &#13199;
            </a>
          </div>
        </div>
        <!-- /.box-header -->
        <div class="box-body collapse in" id="box-body">
          <table datatable [dtOptions]="dtOptions" [dtTrigger]="dtTriggerCart"
                 class="row-border hover table table-striped responsive-table" id="cart">
            <thead>
            <tr>
              <td> Supplier</td>
              <td> Coffee type</td>
              <td> Coffee grade</td>
              <td> Qty</td>
              <td></td>
              <td></td>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let item of cart; let i = index">
              <td> {{ item.cartItemInfo.supplier.name }} </td>
              <td> {{ item.cartItemInfo.coffeeType.name }} </td>
              <td> {{ item.cartItemInfo.coffeeGrade }} </td>
              <td> {{ item.cartItemInfo.totalKgs }} &#13199;</td>
              <td>
                <table style="background: transparent; width: 650px;" class="pull-right">
                  <tr style="font-style: oblique; font-size: 12px; background: transparent; font-weight: bold">
                    <td>Qty</td>
                    <td>Lots</td>
                    <td></td>
                  </tr>
                  <tr *ngFor="let itm of item.cartItem"
                      style="font-style: oblique; font-size: 12px; background: transparent">
                    <td>{{ itm.items.totalKgs }}</td>
                    <td>
                      <button *ngFor="let parchment of itm.items.parchments; let i = index" type="button"
                              class="btn btn-sm btn-link" data-toggle="tooltip"
                              title="{{'Qty : ' + parchment.amountToTransfer + '&#13199; '}}"> {{ parchment.lotNumber }}
                      </button>
                    </td>
                    <td>
                      <a class="btn btn-default btn-margin btn-sm pull-right print-note" (click)="printNote(itm._id)"
                         type="button" id="{{itm._id}}">
                        <i class="fa fa-print" aria-hidden="true"></i>
                      </a>
                    </td>
                  </tr>
                </table>
              </td>
              <td>
                <button class="btn btn-default btn-margin btn-sm pull-right" (click)="cancelCartItem(i)" type="button">
                  <i class="fa fa-remove" aria-hidden="true"></i>
                </button>
              </td>
            </tr>
            </tbody>
          </table>

          <div class="row" style="margin-top: 15px;">
            <div class="col-xs-12">
              <button class="btn btn-success btn-margin pull-right" (click)="onSubmit()"><i class="fa fa-save"></i> Save
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
